#!/usr/bin/env node
/**
 * @author Seena Rowhani
 * service.js
 * Runs job to scrape twitter activity and
 * insert values into sqlite3 db file.
 * @param  {[type]} Twitter, sqlite3, chalk
 * @return void
 */
(function(Twitter, sqlite3, chalk, utils) {
  'use strict';
  var db = new sqlite3.Database('data/tweek.db');
  var client = new Twitter({
    consumer_key: process.env.TWITTER_CONSUMER_KEY,
    consumer_secret: process.env.TWITTER_CONSUMER_SECRET,
    access_token_key: process.env.TWITTER_ACCESS_KEY,
    access_token_secret: process.env.TWITTER_ACCESS_SECRET,
  });
  db.serialize(function() {
    [{
      name: 'tweets',
      params: ['id INTEGER PRIMARY KEY', 'text TEXT', 'user_id INTEGER']
    }, {
      name: 'users',
      params: ['id INTEGER PRIMARY KEY', 'screen_name TEXT', 'profile_image TEXT', 'location TEXT']
    }].forEach(function(e) {
      db.run('create table if not exists ' + e.name + '( ' + e.params.join(', ') + ');')
    });

    client.stream('statuses/filter', {
      lang: 'en',
      track: process.argv[2] || "hello"
    }, function(stream) {
      utils.log('Running job...\nPress CTRL + C to exit.');
      stream.on('data', function(tweet) {
        var abbr = tweet.user.location ? utils.abbr(tweet.user.location) : false;
        if (abbr) {
          db.run('insert into tweets values(?, ?, ?)',
            tweet.id,
            tweet.text,
            tweet.user.id,
            utils.error
          );
          db.run('insert into users values(?, ?, ?, ?)',
            tweet.user.id,
            tweet.user.screen_name,
            tweet.user.profile_image_url,
            abbr,
            utils.error
          );
        }
      });
      stream.on('error', utils.error);
    });
  });
})(require('twitter'),
   require('sqlite3'),
   require('chalk'),
   require('../utils')
 );
require('process').on('SIGINT', function(){
  console.log('\nGoodbye!');
  process.exit();
});
